import json
import boto3
import streamlit as st
import pandas as pd

def classify(payload_data):
    client = boto3.client('sagemaker-runtime')
    endpoint_name = 'pytorch-inference-2024-04-03-15-22-51-188'
    content_type = 'application/json'  # The MIME type of the input data in the request body.
    accept = 'application/json'  # The desired MIME type of the inference in the response.
    response = client.invoke_endpoint(
        EndpointName=endpoint_name,
        ContentType=content_type,
        Accept=accept,
        Body=payload_data
    )

    response_body = response['Body'].read().decode('utf-8')
    response_data = json.loads(response_body)

    return response_data

# Set the page configuration for better resolution
st.set_page_config(page_title="Classification Results", layout="wide")

# Create Streamlit app
st.title('Sagemaker Endpoint Classifier')

# File uploader for uploading files
uploaded_files = st.file_uploader("Upload EXE Files", type=["exe"], accept_multiple_files=True)

if uploaded_files:
    # Display uploaded file names
    st.text("Uploaded files:")
    file_names = [file.name for file in uploaded_files]
    st.text(', '.join(file_names))

    # Button to classify
    if st.button("Classify"):
        results = []
        for uploaded_file in uploaded_files:
            uploaded_file.seek(0)  # Reset file pointer to beginning
            result = classify(uploaded_file.read())
            results.append(result)

        # Display classification results
        #st.title("Classification Results")
        #df = pd.DataFrame(zip(file_names, results), columns=["Filename", "Result"])
        #st.dataframe(df.style.set_properties(**{'text-align': 'left'}), height=500)


        # Add a custom CSS file for styling
        with open("style.css") as f:
            st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

        # Display classification results
        st.title("Classification Results")

        df = pd.DataFrame(zip(file_names, results), columns=["Filename", "Result"])

        # Apply custom styles
        styled_df = df.style.set_properties(**{'text-align': 'left'})
        styled_df = styled_df.set_table_styles([
            {'selector': 'th', 'props': 'background-color: #000; color: #fff;'},
            {'selector': 'tr:hover', 'props': 'background-color: #f5f5f5;'},
            {'selector': 'td', 'props': 'padding: 10px; border: 1px solid #ddd;'}
        ])

        # Display the styled DataFrame
        st.dataframe(styled_df, height=500)
